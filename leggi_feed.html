<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lettore Feed RSS Avanzato</title>
    <!-- Leaflet CSS per la mappa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        :root {
            --primary-color: #0056b3; /* Un blu più professionale */
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545; /* Rosso per scadenze/allarmi */
            --background-light: #f8f9fa;
            --border-color: #e9ecef;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.1);
            --hover-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            background-color: #eef2f7; /* Sfondo leggermente più colorato */
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px; /* Leggermente più largo per le card */
            margin: 0 auto 25px;
            padding: 25px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
        }
        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 30px;
            font-weight: 600;
        }

        /* --- Stili Form di Ricerca --- */
        #search-form {
            background-color: var(--background-light);
            padding: 25px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        /* NUOVO WRAPPER PER LE CATEGORIE */
        .category-wrapper {
            margin-bottom: 25px; /* Spazio dopo l'intero blocco filtri */
        }
        .category-section { 
            margin-bottom: 15px; /* Spazio tra i due gruppi di categorie */
        }
        .category-section:last-child {
            margin-bottom: 0; /* Rimuovi spazio extra */
        }
        .category-label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #495057;
        }
        .category-pills { display: flex; flex-wrap: wrap; gap: 10px; }
        .category-pill {
            background-color: #fff;
            border: 1px solid #ced4da;
            border-radius: 50px;
            padding: 8px 18px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease-in-out;
            color: #495057;
            font-weight: 500;
        }
        .category-pill:hover {
            background-color: #e2e6ea;
            border-color: #adb5bd;
        }
        .category-pill.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(0, 86, 179, 0.3);
        }
        #search-fields {
            display: grid;
            /* Modificato per 2 campi sulla prima riga */
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px;
            margin-bottom: 25px;
        }
        /* NUOVO CSS PER I WRAPPER DEI CAMPI */
        .ente-fields-wrapper,
        .range-fields-wrapper { /* AGGIUNTO */
            /* Occupa l'intera larghezza della griglia principale */
            grid-column: 1 / -1; 
            display: grid;
            /* Due colonne per i menu a tendina */
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .form-group { display: flex; flex-direction: column; }
        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #495057;
        }
        /* Stile unificato per input e select */
        .form-group input, .form-group select {
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
            background-color: #fff;
            height: 48px; /* Altezza fissa per allineamento */
            box-sizing: border-box; /* Include padding nell'altezza */
            width: 100%; /* Assicura che riempiano il contenitore grid */
        }
        /* Stile per il <select> per farlo assomigliare all'input */
        .form-group select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.1);
        }
        /* Correzione per input tipo 'date' */
        .form-group input[type="date"] {
            padding-right: 0.75rem; /* Rimuovi padding extra su input date */
        }
        
        #controls-container {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            justify-content: space-between; /* Spazia i controlli */
        }
        #controls-container button[type="submit"] {
            padding: 12px 30px;
            border: none;
            background-color: var(--success-color);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            height: 48px; /* Allinea con gli input */
        }
        #controls-container button[type="submit"]:hover {
            background-color: #218838;
            transform: translateY(-1px);
        }
        #controls-container button[type="submit"]:active { transform: translateY(1px); }

        /* --- Logica per nascondere i filtri nel tab "Cerca Esito" --- */
        #search-form.esito-mode .category-wrapper, /* Modificato */
        #search-form.esito-mode #oggetto-input-group,
        #search-form.esito-mode .ente-fields-wrapper, /* CORRETTO */
        #search-form.esito-mode .range-fields-wrapper, /* AGGIUNTO */
        #search-form.esito-mode #num-results-group {
            display: none;
        }
        #search-form.esito-mode #search-fields {
            grid-template-columns: 1fr; /* Il CIG prende tutta la larghezza */
        }
        #search-form.esito-mode #controls-container {
            justify-content: flex-end; /* Sposta il pulsante a destra */
        }

        /* --- Stili Tabs --- */
        .tabs {
            display: flex;
            flex-wrap: wrap; /* Per mobile */
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 25px;
        }
        .tab-link {
            padding: 12px 20px; /* Leggermente meno padding per 4 tab */
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            font-weight: 500;
            color: var(--secondary-color);
            position: relative;
            transition: color 0.3s;
            text-align: center;
            flex-grow: 1; /* Per mobile */
        }
        .tab-link::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: transparent;
            transition: background-color 0.3s;
        }
        .tab-link.active { color: var(--primary-color); font-weight: 600; }
        .tab-link.active::after { background-color: var(--primary-color); }

        /* --- STILI CARD (Feed Item) --- */
        .feed-item {
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            position: relative; /* Per posizionare elementi assoluti se necessario */
        }
        /* Effetto hover per far sembrare le card "cliccabili" o importanti */
        .feed-item:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-3px);
            border-color: #d6d8db;
        }

        /* Stile specifico per la vista SINTETICA */
        .synthetic-card {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        /* Intestazione della card sintetica */
        .synthetic-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .synthetic-title {
            font-size: 1.3rem;
            color: #2c3e50;
            margin: 0;
            font-weight: 700;
            flex-grow: 1; /* Prende lo spazio disponibile */
            margin-right: 15px;
        }
        .synthetic-badges {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            flex-shrink: 0; /* Non si restringe */
        }
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .badge-cig { background-color: #e9ecef; color: #495057; }
        .badge-esito { background-color: #d4edda; color: #155724; } /* Verde per esito positivo/pubblicato */
        
        /* Corpo della card sintetica */
        .synthetic-body {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Griglia responsive interna */
            gap: 20px;
        }
        .info-group {
            display: flex;
            flex-direction: column;
        }
        .info-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            color: var(--secondary-color);
            font-weight: 700;
            margin-bottom: 5px;
        }
        .info-value {
            font-size: 1rem;
            color: #212529;
        }
        /* Stili specifici per alcuni valori */
        .info-value.ente { font-weight: 600; color: var(--primary-color); }
        .info-value.importo {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--success-color); /* Verde soldi */
        }
        .info-value.oggetto {
            line-height: 1.5;
            color: #555;
        }
        .info-value.scadenza {
            font-weight: 700;
            color: var(--danger-color); /* Rosso per evidenziare la scadenza */
        }

        /* Footer della card con il pulsante */
        .synthetic-footer {
            margin-top: 20px;
            text-align: right;
        }
        .btn-details {
            display: inline-block;
            padding: 10px 25px;
            background-color: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-details:hover { background-color: #004494; text-decoration: none; }

        /* Stile per la vista COMPLETA (più simile a una lista tecnica) */
        .full-card h2 { font-size: 1.4em; margin-top: 0; color: var(--primary-color); }
        .full-card h2 a { text-decoration: none; color: inherit; }
        .full-card h2 a:hover { text-decoration: underline; }
        .full-card dl { display: grid; grid-template-columns: auto 1fr; gap: 10px 20px; margin: 0; }
        .full-card dt { font-weight: 700; color: #555; text-align: right; padding-right: 10px; border-right: 2px solid #eee; }
        .full-card dd { margin: 0; word-break: break-word; }

        /* --- Stili per Tab "Cerca Esito CIG" --- */
        #esito-container { display: none; }
        #esito-container ul { list-style: none; padding-left: 0; }
        #esito-container li { 
            background: #fdfdfd; 
            border: 1px solid #eee; 
            padding: 20px; 
            margin-bottom: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
            /* Modifica per pulsante */
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        #esito-container li:hover {
             border-color: #ddd;
             box-shadow: 0 4px 8px rgba(0,0,0,0.07);
        }
        #esito-container .esito-info {
            flex-grow: 1;
        }
        #esito-container .esito-info strong { 
            font-weight: 600; 
            font-size: 1.1rem;
            color: var(--primary-color); 
        }
         #esito-container .esito-info p {
             margin: 8px 0 0 0;
             font-size: 0.9rem;
             color: #555;
         }
         #esito-container .esito-link .btn-details {
             padding: 8px 20px; /* Pulsante più piccolo */
             font-size: 0.9rem;
         }


        /* --- Altri Stili --- */
        #pagination-container { display: flex; justify-content: center; gap: 15px; margin-top: 30px; }
        #pagination-container button {
            padding: 10px 20px;
            cursor: pointer;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            transition: all 0.2s;
        }
        #pagination-container button:hover:not(:disabled) { background-color: #e9ecef; border-color: #adb5bd; }
        #pagination-container button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* --- STILI DI CARICAMENTO E ERRORE --- */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 50px 20px;
            color: var(--secondary-color);
        }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .error-message { text-align: center; font-size: 1.2em; color: var(--secondary-color); padding: 40px; }
        .error-message { color: #dc3545; background-color: #fff5f5; border-radius: 8px; border: 1px solid #f5c6cb; }
        #results-status { text-align: center; font-style: italic; color: var(--secondary-color); margin-bottom: 20px; }
        #retry-btn { margin-top: 15px; padding: 10px 25px; font-size: 1em; cursor: pointer; background-color: var(--primary-color); color: white; border: none; border-radius: 6px; }
        
        /* --- STILI MAPPA --- */
        #map-wrapper {
            position: relative; /* Necessario per posizionare l'overlay di caricamento sopra */
        }
        #map-container {
            height: 600px; /* Altezza fissa per la mappa */
            width: 100%;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            /* Nascondi di default, mostrato via JS quando attivo il tab */
            display: none; 
        }
        /* Assicura che la mappa sia visibile quando il tab è attivo */
        #map-container.active {
            display: block;
        }
        /* Overlay di caricamento per la mappa */
        #map-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 1000; /* Assicurati che sia sopra la mappa Leaflet */
            display: none; /* Nascosto di default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }
        #map-loading-overlay.active {
            display: flex;
        }

        /* Stili per il popup della mappa */
        .leaflet-popup-content {
            font-family: 'Segoe UI', sans-serif;
            line-height: 1.4;
        }
        .leaflet-popup-content b {
            color: var(--primary-color);
            font-size: 1.1em;
        }
        .leaflet-popup-content a {
            display: inline-block;
            margin-top: 8px;
            color: white;
            background-color: var(--primary-color);
            padding: 4px 10px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.9em;
        }
        .leaflet-popup-content a:hover {
            background-color: #004494;
        }


        /* Media query per schermi piccoli */
        @media (max-width: 768px) {
            .tabs { flex-direction: column; }
            .tab-link { font-size: 0.9rem; padding: 12px 10px;}
            #search-fields { grid-template-columns: 1fr; } /* Campi di ricerca in colonna */
            .ente-fields-wrapper, .range-fields-wrapper { grid-template-columns: 1fr; } /* Anche i wrapper in colonna */
            .synthetic-header { flex-direction: column; }
            .synthetic-badges { align-items: flex-start; margin-top: 15px; flex-direction: row; }
            .full-card dl { grid-template-columns: 1fr; }
            .full-card dt { text-align: left; border-right: none; border-bottom: 1px solid #eee; padding-bottom: 5px; }
            .full-card dd { margin-bottom: 15px; padding-left: 10px; }
            #controls-container { flex-direction: column; align-items: stretch; }
            #controls-container button[type="submit"] { width: 100%; }
             #map-container { height: 400px; } /* Mappa più piccola su mobile */
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>INVA - Bandi PlaCe-VdA</h1>
        <form id="search-form">
            
            <!-- MODIFICA: Creato un wrapper e due sezioni separate -->
            <div class="category-wrapper">
                <div class="category-section">
                    <span class="category-label">Categoria:</span>
                    <div class="category-pills">
                        <!-- Categorie principali (contratti) - Aggiunta classe contract-pill -->
                        <button type="button" class="category-pill contract-pill" data-cat="lavori">Lavori</button>
                        <button type="button" class="category-pill contract-pill" data-cat="servizi">Servizi</button>
                        <button type="button" class="category-pill contract-pill" data-cat="forniture">Forniture</button>
                    </div>
                </div>
                <div class="category-section">
                    <span class="category-label">Categorie merceologiche:</span>
                    <div class="category-pills">
                        <!-- NUOVE categorie dal CSV -->
                        <button type="button" class="category-pill merceologica-pill" data-cat="ict">ICT e Digitalizzazione</button>
                        <button type="button" class="category-pill merceologica-pill" data-cat="generali">Beni e Servizi Generali</button>
                        <button type="button" class="category-pill merceologica-pill" data-cat="sanita_dispositivi">Sanità - Dispositivi e Farmaci</button>
                        <button type="button" class="category-pill merceologica-pill" data-cat="sanita_servizi">Sanità - Servizi Specialistici</button>
                        <button type="button" class="category-pill merceologica-pill" data-cat="energia">Energia, Combustibili e Utilities</button>
                        <button type="button" class="category-pill merceologica-pill" data-cat="efficienza">Efficienza Energetica e Sostenibilità</button>
                        <button type="button" class="category-pill merceologica-pill" data-cat="facility">Facility Management</button>
                        <button type="button" class="category-pill merceologica-pill" data-cat="trasporti">Veicoli, Mobilità e Trasporti</button>
                        <button type="button" class="category-pill merceologica-pill" data-cat="consulenza">Servizi Professionali e di Consulenza</button>
                        <button type="button" class="category-pill merceologica-pill" data-cat="cultura">Patrimonio Culturale</button>
                        <button type="button" class="category-pill merceologica-pill" data-cat="ristorazione">Ristorazione Collettiva</button>
                        <button type="button" class="category-pill merceologica-pill" data-cat="sicurezza">Sicurezza e Vigilanza</button>
                    </div>
                </div>
            </div>

            <div id="search-fields">
                <div class="form-group" id="cig-input-group">
                    <label for="cig-input">CIG:</label>
                    <input type="text" id="cig-input" placeholder="Cerca per CIG...">
                </div>
                <div class="form-group" id="oggetto-input-group">
                    <label for="oggetto-input">Oggetto del bando:</label>
                    <input type="text" id="oggetto-input" placeholder="Parole chiave nell'oggetto...">
                </div>
                
                <!-- NUOVO WRAPPER PER I CAMPI ENTE -->
                <div class="ente-fields-wrapper">
                    <div class="form-group" id="ente-proponente-group">
                        <label for="ente-proponente-select">Ente Proponente:</label>
                        <select id="ente-proponente-select"></select>
                    </div>
                    <div class="form-group" id="ente-appaltante-group">
                        <label for="ente-appaltante-select">Ente Appaltante:</label>
                        <select id="ente-appaltante-select"></select>
                    </div>
                </div>

                <!-- NUOVO WRAPPER PER I CAMPI RANGE -->
                <div class="range-fields-wrapper">
                    <div class="form-group" id="importo-da-group">
                        <label for="importo-da-input">Importo da:</label>
                        <input type="number" id="importo-da-input" placeholder="Es. 10000" min="0">
                    </div>
                    <div class="form-group" id="importo-a-group">
                        <label for="importo-a-input">Importo a:</label>
                        <input type="number" id="importo-a-input" placeholder="Es. 50000" min="0">
                    </div>
                    <div class="form-group" id="data-da-group">
                        <label for="data-da-input">Scadenza da:</label>
                        <input type="date" id="data-da-input">
                    </div>
                    <div class="form-group" id="data-a-group">
                        <label for="data-a-input">Scadenza a:</label>
                        <input type="date" id="data-a-input">
                    </div>
                </div>
            </div>
            <div id="controls-container">
                <div class="form-group" id="num-results-group" style="max-width: 150px;">
                    <label for="num-results-input">Risultati/pag:</label>
                    <input type="number" id="num-results-input" value="10" min="1" max="1000">
                </div>
                <button type="submit">Applica Filtri</button>
            </div>
        </form>
    </div>

    <div class="container" style="padding-top: 0;">
         <div class="tabs">
            <button class="tab-link active" data-view="sintetico">Bandi Attivi</button>
            <button class="tab-link" data-view="completo">Vista Completa</button>
            <button class="tab-link" data-view="mappa">Mappa Bandi</button>
            <button class="tab-link" data-view="cerca-esito">Cerca Esito CIG</button>
        </div>
        
        <div id="results-status-container"></div>
        
        <!-- Wrapper per la mappa con overlay di caricamento -->
        <div id="map-wrapper">
            <div id="map-loading-overlay">
                <div class="loading-spinner"></div>
                <div class="loading-text">Aggiornamento mappa...</div>
            </div>
            <div id="map-container"></div>
        </div>

        <!-- Contenitore per i risultati della ricerca Esiti -->
        <div id="esito-container"></div>

        <div id="feed-container">
            <!-- I contenuti del feed verranno inseriti qui -->
        </div>
        
        <div id="pagination-controls" style="display: none;">
            <div id="pagination-container">
                <button id="prev-page-btn">&laquo; Precedente</button>
                <span id="current-page-span">Pagina 1</span>
                <button id="next-page-btn">Successiva &raquo;</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS per la mappa -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // --- ELEMENTI DEL DOM ---
        const searchForm = document.getElementById('search-form');
        const feedContainer = document.getElementById('feed-container');
        const esitoContainer = document.getElementById('esito-container');
        const mapContainer = document.getElementById('map-container');
        const mapWrapper = document.getElementById('map-wrapper');
        const mapLoadingOverlay = document.getElementById('map-loading-overlay');
        const numResultsInput = document.getElementById('num-results-input');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const currentPageSpan = document.getElementById('current-page-span');
        const paginationControls = document.getElementById('pagination-controls');
        const tabButtons = document.querySelectorAll('.tab-link');
        // Seleziona i due gruppi di pillole separatamente
        const contractPills = document.querySelectorAll('.contract-pill');
        const merceologicaPills = document.querySelectorAll('.merceologica-pill');
        const resultsStatusContainer = document.getElementById('results-status-container');
        // Nuovi elementi select
        const enteProponenteSelect = document.getElementById('ente-proponente-select');
        const enteAppaltanteSelect = document.getElementById('ente-appaltante-select');

        // --- STATO DELL'APPLICAZIONE ---
        let currentPage = 1;
        let fetchedItems = [];
        let currentView = 'sintetico';
        // Variabili separate per i filtri
        let selectedContractType = '';
        let selectedMerceologica = '';
        let map = null; // Riferimento alla mappa Leaflet
        let markersLayer = null; // Layer per i cluster di pin sulla mappa

        // --- DB ENTI (Simulato - Primi 20 come richiesto) ---
        const entiList = [
            "\"\"\"CENTRO DI STUDI STORICO-LETTERARI NATALINO SAPEGNO\"\" ONLUS\"",
            "AGENZIA REGIONALE DEI SEGRETARI DEGLI ENTI LOCALI DELLA VALLE D’AOSTA",
            "ANPAS Comitato Regionale Valle d’Aosta Federazione Regionale del Soccorso VDA-ODV",
            "AREA VDA - AGENZIA REGIONALE PER LE EROGAZIONE IN AGRICOLTURA DELLA REGIONE AUTONOMA VALLE D'AOSTA",
            "ARER VALLE D'AOSTA",
            "ARPA VALLE D'AOSTA",
            "ASSOCIATION REGIONALE ELEVEURS VALDOTAINS (A.R.E.V.)",
            "ASSOCIAZIONE FORTE DI BARD",
            "ASSOCIAZIONE VALDOSTANA MAESTRI DI SCI - AVMS",
            "AVDA SPA",
            "AZIENDA PUBBLICI SERVIZI AOSTA SOCIETA PER AZIONI",
            "AZIENDA USL VALLE D'AOSTA",
            "C.M.F. SAINT-PIERRE VILLENEUVE",
            "CAMERA VALDOSTANA DELLE IMPRESE E DELLE PROFESSIONI",
            "CASA DI RIPOSO J. B. FESTAZ",
            "CENTRO SERVIZI COURMAYEUR SRL",
            "CERVIM",
            "CHAMOIS SERVIZI SRL",
            "COLLEGIO GEOMETRI E GEOMETRI LAUREATI DELLA VALLE D’AOSTA",
            "COMUNE DI ALLEIN"
            // Lista completa omessa per stabilità
        ];

        // --- LISTA COMPLETA COORDINATE 74 COMUNI VDA ---
        const comuniVdA = {
            "allein": [45.8083, 7.2717],
            "antey-saint-andré": [45.7953, 7.5906],
            "aosta": [45.7372, 7.3206],
            "arnad": [45.6444, 7.7203],
            "arvier": [45.7022, 7.1667],
            "avise": [45.7092, 7.1406],
            "ayas": [45.8139, 7.6933],
            "aymavilles": [45.6983, 7.2447],
            "bard": [45.6086, 7.7444],
            "bionaz": [45.8647, 7.4156],
            "brissogne": [45.7325, 7.4036],
            "brusson": [45.7589, 7.7289],
            "challand-saint-anselme": [45.7161, 7.7425],
            "challand-saint-victor": [45.6922, 7.7056],
            "chambave": [45.7447, 7.5517],
            "chamois": [45.8389, 7.6183],
            "champdepraz": [45.6858, 7.6558],
            "champorcher": [45.6236, 7.6206],
            "charvensod": [45.7233, 7.3247],
            "châtillon": [45.7497, 7.6197],
            "cogne": [45.6083, 7.3556],
            "courmayeur": [45.7969, 6.9694],
            "donnas": [45.6053, 7.7689],
            "doues": [45.8178, 7.3142],
            "emarèse": [45.7231, 7.6997],
            "etroubles": [45.8214, 7.2297],
            "fénis": [45.7342, 7.4928],
            "fontainemore": [45.6453, 7.8586],
            "gaby": [45.7111, 7.8819],
            "gignod": [45.7839, 7.2939],
            "gressan": [45.7247, 7.2894],
            "gressoney-la-trinité": [45.8494, 7.8247],
            "gressoney-saint-jean": [45.7775, 7.8242],
            "hône": [45.6133, 7.7397],
            "introd": [45.6908, 7.1831],
            "issime": [45.6842, 7.8536],
            "issoire": [45.7339, 7.5150], 
            "jovençan": [45.7147, 7.2731],
            "la magdeleine": [45.8161, 7.6172],
            "la salle": [45.7469, 7.0767],
            "la thuile": [45.7150, 6.9500],
            "lillianes": [45.6331, 7.8453],
            "montjovet": [45.6958, 7.6589],
            "morgex": [45.7569, 7.0389],
            "nus": [45.7403, 7.4669],
            "ollomont": [45.8497, 7.3125],
            "oyace": [45.8489, 7.3794],
            "perloz": [45.6136, 7.8131],
            "pollein": [45.7294, 7.3567],
            "pont-saint-martin": [45.5989, 7.7956],
            "pontboset": [45.6072, 7.6869],
            "pontey": [45.7408, 7.5878],
            "pré-saint-didier": [45.7650, 6.9872],
            "quart": [45.7414, 7.4147],
            "rhêmes-notre-dame": [45.5697, 7.1189],
            "rhêmes-saint-georges": [45.6567, 7.1542],
            "roisan": [45.7675, 7.3169],
            "saint-christophe": [45.7533, 7.3542],
            "saint-denis": [45.7506, 7.5572],
            "saint-marcel": [45.7375, 7.4486],
            "saint-nicolas": [45.7178, 7.1664],
            "saint-oyen": [45.8261, 7.2158],
            "saint-pierre": [45.7103, 7.2311],
            "saint-rhémy-en-bosses": [45.8225, 7.1808],
            "saint-vincent": [45.7500, 7.6458],
            "sarre": [45.7231, 7.2581],
            "torgnon": [45.8086, 7.5689],
            "valgrisenche": [45.6303, 7.0628],
            "valpelline": [45.8300, 7.3256],
            "valsavarenche": [45.5936, 7.2097],
            "valtournenche": [45.8792, 7.6236],
            "verrès": [45.6694, 7.6889],
            "verrayes": [45.7628, 7.5339],
            "villeneuve": [45.7036, 7.2089],
            // Alias e altri enti comuni
            "inva": [45.7533, 7.3542], // Saint-Christophe
            "regione autonoma valle d'aosta": [45.7372, 7.3206], // Aosta
            "azienda usl valle d'aosta": [45.7372, 7.3206], // Aosta
            "ausl valle d'aosta": [45.7372, 7.3206], // Aosta
            "unite des communes valdotaines grand-paradis": [45.7036, 7.2089], // Villeneuve
             "unite des communes valdotaines valdigne-mont-blanc": [45.7469, 7.0767], // La Salle
             "unite des communes valdotaines mont-emilius": [45.7414, 7.4147], // Quart
             "unite des communes valdotaines mont-cervin": [45.7497, 7.6197], // Châtillon
             "unite des communes valdotaines evancon": [45.6694, 7.6889], // Verrès
             "unite des communes valdotaines mont-rose": [45.5989, 7.7956], // Pont-Saint-Martin
             "unite des communes valdotaines walser": [45.6842, 7.8536], // Issime
             "bim": [45.7372, 7.3206], // Aosta
             "celva": [45.7372, 7.3206] // Aosta
        };

        // --- SINONIMI PER CATEGORIE ---
        // MODIFICATO: Dizionario aggiornato in base al file CSV
        const categorySynonyms = {
            'ict': ['software', 'hardware', 'digitale', 'pc', 'computer', 'server', 'rete', 'web', 'sito', 'app', 'cloud', 'ict', 'telefonia', 'dati', 'digitalizzazione', 'connettività'],
            'generali': ['cancelleria', 'arredi', 'pulizia', 'logistica', 'archivio', 'postali', 'copisteria', 'materiali consumo', 'beni', 'amministrativi', 'ufficio'],
            'sanita_dispositivi': ['farmaci', 'vaccini', 'dispositivi medici', 'presidi', 'biomedicali', 'diagnostici', 'protesi', 'stent', 'guanti', 'siringhe'],
            'sanita_servizi': ['manutenzione apparecchiature', 'diagnostica', 'lavanolo', 'gestione ospedaliera', 'usl', 'asl', 'socio-sanitario', 'assistenza sanitaria', 'servizi sanitari'],
            'energia': ['energia elettrica', 'gas', 'carburanti', 'combustibili', 'utilities', 'metano', 'gpl', 'fornitura energia'],
            'efficienza': ['efficientamento', 'illuminazione', 'led', 'cappotto termico', 'fotovoltaico', 'sostenibilità', 'consumi', 'esco', 'riqualificazione energetica'],
            'facility': ['pulizia', 'manutenzione ordinaria', 'giardinaggio', 'portierato', 'reception', 'facility management', 'guardiania', 'global service', 'immobili'],
            'trasporti': ['veicoli', 'noleggio', 'acquisto auto', 'pneumatici', 'flotte', 'manutenzione veicoli', 'trasporto pubblico', 'scuolabus', 'mobilità'],
            'consulenza': ['professionali', 'consulenza', 'legale', 'fiscale', 'formazione', 'supporto tecnico', 'amministrativo', 'progettazione', 'incarico professionale'],
            'cultura': ['restauro', 'conservazione', 'musei', 'archivi', 'biblioteche', 'evento culturale', 'patrimonio culturale', 'turismo', 'beni culturali', 'spettacolo'],
            'ristorazione': ['ristorazione', 'catering', 'mense', 'pasti', 'viveri', 'derrate alimentari', 'refezione'],
            'sicurezza': ['vigilanza', 'guardiania', 'sicurezza', 'antincendio', 'videosorveglianza', 'portierato armato']
        };
        
        // --- NUOVA FUNZIONE PER POPOLARE I MENU A TENDINA DEGLI ENTI ---
        function populateEnteSelects() {
            // Opzione di default
            const defaultOption = '<option value="">Tutti</option>';
            enteProponenteSelect.innerHTML = defaultOption;
            enteAppaltanteSelect.innerHTML = defaultOption;

            // Popola la lista
            entiList.forEach(ente => {
                // Rimuovi eventuali virgolette extra per il valore e il testo
                const cleanEnte = ente.replace(/^"+|"+$/g, '').replace(/""/g, '"');
                const optionHtml = `<option value="${cleanEnte}">${cleanEnte}</option>`;
                enteProponenteSelect.insertAdjacentHTML('beforeend', optionHtml);
                enteAppaltanteSelect.insertAdjacentHTML('beforeend', optionHtml);
            });
        }


        // --- COSTRUZIONE URL (Bandi) ---
        function buildUrl() {
            const baseUrl = "https://place-vda.aflink.it/portale/rss_new.asp";
            const numResults = numResultsInput.value;
            const cig = document.getElementById('cig-input').value.trim();
            let oggetto = document.getElementById('oggetto-input').value.trim();
            // Legge dai nuovi menu a tendina
            const enteProponente = enteProponenteSelect.value;
            const enteAppaltante = enteAppaltanteSelect.value;
            // --- INIZIO NUOVE AGGIUNTE ---
            const importoDa = document.getElementById('importo-da-input').value;
            const importoA = document.getElementById('importo-a-input').value;
            const dataDa = document.getElementById('data-da-input').value;
            const dataA = document.getElementById('data-a-input').value;
            // --- FINE NUOVE AGGIUNTE ---

            const params = new URLSearchParams({
                Table: 'DASHBOARD_VIEW_DOCUMENTI_PUBBLICI',
                FilterHide: "bScaduto=0 and tipo<>'Esito'", 
                ML_KEY: 'TEMPLATE_RSS_DPCM_ML',
                sort: 'DtScadenzaBandoTecnical',
                sortorder: 'asc',
                numRowForPag: numResults,
                nPag: currentPage
            });

            const filters = [];
            // --- REVISIONE DI TUTTI I FILTRI (rimozione namespace 'afs:') ---
            if (cig) filters.push(`CIG LIKE '%${encodeURIComponent(cig)}%'`);
            if (oggetto) filters.push(`Oggetto LIKE '%${encodeURIComponent(oggetto)}%'`); // MODIFICATO
            
            // --- MODIFICA LOGICA FILTRI CATEGORIA ---
            // Filtro per Categoria (Contratto)
            if (selectedContractType) {
                 filters.push(`Contratto LIKE '%${encodeURIComponent(selectedContractType)}%'`); // MODIFICATO
            }
            // Filtro per Categoria Merceologica (Oggetto)
            if (selectedMerceologica) {
                const catLower = selectedMerceologica.toLowerCase();
                const synonyms = categorySynonyms[catLower] || [catLower];
                const orQuery = synonyms.map(word => `Oggetto LIKE '%${encodeURIComponent(word)}%'`).join(' OR '); // MODIFICATO
                filters.push(`(${orQuery})`);
            }
            // --- FINE MODIFICA ---
            
            // --- MODIFICA FILTRI ENTE ---
            // Riportati a LIKE e rimosso namespace
            if (enteProponente) {
                filters.push(`EnteProponente LIKE '%${enteProponente.replace(/'/g, "''")}%'`);
            }
            if (enteAppaltante) {
                filters.push(`DenominazioneEnte LIKE '%${enteAppaltante.replace(/'/g, "''")}%'`);
            }
            // --- FINE MODIFICA ---
            
            // --- INIZIO NUOVE AGGIUNTE FILTRI RANGE ---
            // Rimosso namespace
            if (importoDa) filters.push(`a_base_asta >= ${importoDa}`);
            if (importoA) filters.push(`a_base_asta <= ${importoA}`);
            
            // Rimosso namespace e CORRETTO
            if (dataDa) filters.push(`DtScadenzaBandoTecnical >= '${dataDa}T00:00:00'`);
            if (dataA) filters.push(`DtScadenzaBandoTecnical <= '${dataA}T23:59:59'`);
            // --- FINE MODIFICA ---

            if (filters.length > 0) params.set('Filter', filters.join(' AND '));
            return `${baseUrl}?${params.toString()}`;
        }
        
        // --- COSTRUZIONE URL (Esiti per CIG) ---
        function buildEsitoUrl(cig) {
             const baseUrl = "https://place-vda.aflink.it/portale/rss_new.asp";
             const params = new URLSearchParams({
                Table: 'DASHBOARD_VIEW_DOCUMENTI_PUBBLICI',
                FilterHide: "bScaduto=0 and tipo='Esito'", // CERCA SOLO ESITI
                ML_KEY: 'TEMPLATE_RSS_DPCM_ML',
                sort: 'DtPubblicazione',
                sortorder: 'DESC',
                Filter: `CIG LIKE '%${encodeURIComponent(cig)}%'` // Filtra per CIG
            });
            return `${baseUrl}?${params.toString()}`;
        }

        function formatDate(dateString) {
            if (!dateString || dateString === 'N/D') return 'N/D';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ore ${hours}:${minutes}`;
            } catch (e) { return dateString; }
        }

        function formatOggetto(text) {
            if (!text) return 'Descrizione non disponibile';
            return text.replace(/\s*(Scadenza:)/gi, '<br><strong style="color:#dc3545;">$1</strong>');
        }

        // --- FUNZIONE PER INIZIALIZZARE E AGGIORNARE LA MAPPA ---
        function updateMap() {
            if (!map) {
                // Inizializza la mappa se non esiste ancora
                map = L.map('map-container').setView([45.737, 7.320], 10); // Centra su Aosta
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                    attribution: '© OpenStreetMap'
                }).addTo(map);
                // Usa un MarkerClusterGroup invece di un LayerGroup standard
                markersLayer = L.markerClusterGroup({
                    showCoverageOnHover: false, // Disattiva l'area blu al passaggio del mouse sui cluster
                    maxClusterRadius: 50 // Raggio di raggruppamento (più basso = meno raggruppamento)
                }).addTo(map);
            }

            markersLayer.clearLayers(); // Pulisci i vecchi marker

            fetchedItems.forEach(item => {
                const data = extractData(item);
                // Usa il dato grezzo per la mappa
                const enteNormalized = data.ente_raw ? data.ente_raw.toLowerCase()
                    .replace('communauté de montagne', 'unite des communes valdotaines')
                    .replace("unite' des communes valdotaines", 'unite des communes valdotaines') : "";
                
                let coords = null;
                // Cerca corrispondenza esatta o parziale nel dizionario
                for (const key in comuniVdA) {
                    if (enteNormalized.includes(key)) {
                        coords = comuniVdA[key];
                        if (enteNormalized === key) break;
                    }
                }

                if (coords) {
                     // --- CORREZIONE LINK E DATI POPUP ---
                    let linkRaw = item.querySelector("link")?.textContent?.trim() || '#';
                    linkRaw = linkRaw.replace(/\/\/*portale\//g, '/portalegare/');
                    const txt = document.createElement("textarea");
                    txt.innerHTML = linkRaw;
                    linkRaw = txt.value;

                    const title = item.querySelector("title")?.textContent || 'Bando';
                    let shortOggetto = data.oggetto.length > 100 ? data.oggetto.substring(0, 100) + '...' : data.oggetto;

                    const popupContent = `
                        <div style="max-width: 250px;">
                            <b>${title}</b><br>
                            <small style="color: #666;">${data.enteProponente}</small><br>
                            <p style="margin: 8px 0;">${shortOggetto}</p>
                            <span style="color: #dc3545; font-size: 0.9em;">Scadenza: ${formatDate(data.scadenza)}</span><br>
                            <a href="${linkRaw}" target="_blank">Vedi dettagli gara &rarr;</a>
                        </div>
                    `;
                    
                    // Aggiungi il marker al Cluster Group invece che direttamente alla mappa
                    markersLayer.addLayer(L.marker(coords).bindPopup(popupContent));
                }
            });
        }
        
        // --- FUNZIONE DI VISUALIZZAZIONE PRINCIPALE ---
        function displayItems() {
            // Gestione visibilità dei container in base alla view corrente
            if (currentView === 'mappa') {
                feedContainer.style.display = 'none';
                esitoContainer.style.display = 'none';
                mapWrapper.style.display = 'block';
                mapContainer.classList.add('active');
                // Timeout necessario per far renderizzare correttamente la mappa quando diventa visibile
                setTimeout(() => { 
                    if (map) map.invalidateSize(); 
                }, 300); 
            } else if (currentView === 'cerca-esito') {
                feedContainer.style.display = 'none';
                mapWrapper.style.display = 'none';
                esitoContainer.style.display = 'block';
            } else { // Viste 'sintetico' o 'completo'
                feedContainer.style.display = 'block';
                mapWrapper.style.display = 'none';
                esitoContainer.style.display = 'none';
            }

            // Popola solo se la vista non è mappa e non è cerca-esito
            if (currentView === 'sintetico' || currentView === 'completo') {
                 feedContainer.innerHTML = '';
                 if (!fetchedItems || fetchedItems.length === 0) {
                    feedContainer.innerHTML = "<p style='text-align:center; padding: 20px;'>Nessun elemento trovato per i criteri specificati.</p>";
                    nextPageBtn.disabled = true;
                    return;
                }
                resultsStatusContainer.innerHTML = `<p id="results-status">Trovati ${fetchedItems.length} risultati in questa pagina.</p>`;
                try {
                    fetchedItems.forEach(item => {
                        const title = item.querySelector("title")?.textContent || 'N/D';
                        let linkRaw = item.querySelector("link")?.textContent?.trim() || '#';
                        linkRaw = linkRaw.replace(/\/\/*portale\//g, '/portalegare/');
                        const txt = document.createElement("textarea");
                        txt.innerHTML = linkRaw;
                        linkRaw = txt.value;
                        
                        const cardDiv = document.createElement('div');
                        cardDiv.className = `feed-item ${currentView === 'sintetico' ? 'synthetic-card' : 'full-card'}`;

                        if (currentView === 'sintetico') {
                            const data = extractData(item);
                            cardDiv.innerHTML = `
                                <div class="synthetic-header">
                                    <h3 class="synthetic-title">${title}</h3>
                                    <div class="synthetic-badges">
                                        ${data.esito ? `<span class="badge badge-esito">${data.esito}</span>` : ''}
                                        ${data.cig ? `<span class="badge badge-cig">CIG: ${data.cig}</span>` : ''}
                                    </div>
                                </div>
                                <div class="synthetic-body">
                                    <!-- MODIFICA: Mostra entrambi gli enti -->
                                    <div class="info-group" style="grid-column: 1 / -1;">
                                        <span class="info-label">Ente Proponente</span>
                                        <span class="info-value ente">${data.enteProponente}</span>
                                    </div>
                                    <div class="info-group" style="grid-column: 1 / -1;">
                                        <span class="info-label">Ente Appaltante</span>
                                        <span class="info-value ente">${data.enteAppaltante}</span>
                                    </div>
                                    <div class="info-group" style="grid-column: 1 / -1;">
                                        <span class="info-label">Oggetto del Bando</span>
                                        <span class="info-value oggetto">${formatOggetto(data.oggetto)}</span>
                                    </div>
                                    <div class="info-group">
                                        <span class="info-label">Base d'Asta</span>
                                        <span class="info-value importo">${data.baseAsta}</span>
                                    </div>
                                    <div class="info-group">
                                        <span class="info-label">Scadenza Bando</span>
                                        <span class="info-value scadenza">${formatDate(data.scadenza)}</span>
                                    </div>
                                     <div class="info-group">
                                        <span class="info-label">Tipologia</span>
                                        <span class="info-value">${data.contratto}</span>
                                    </div>
                                </div>
                                <div class="synthetic-footer">
                                    <a href="${linkRaw}" target="_blank" rel="noopener noreferrer" class="btn-details">Vedi Dettagli Gara &rarr;</a>
                                </div>
                            `;
                        } else {
                            let dlContent = '';
                            for (const node of item.children) {
                                if (node.tagName !== 'title' && node.tagName !== 'link') dlContent += `<dt>${node.tagName}</dt><dd>${node.textContent}</dd>`;
                            }
                            cardDiv.innerHTML = `<h2><a href="${linkRaw}" target="_blank">${title}</a></h2><dl>${dlContent}</dl>`;
                        }
                        feedContainer.appendChild(cardDiv);
                    });
                } catch (error) { console.error("Errore visualizzazione:", error); }
            }
        }

        function extractData(itemXml) {
            const getSafe = (tagCandidates) => {
                if (!Array.isArray(tagCandidates)) tagCandidates = [tagCandidates];
                for (const tag of tagCandidates) {
                    const node = Array.from(itemXml.children).find(n => 
                        n.tagName === tag || n.tagName.toLowerCase() === tag.toLowerCase() || 
                        n.nodeName === tag || n.nodeName.toLowerCase() === tag.toLowerCase()
                    );
                    if (node && node.textContent) return node.textContent.trim();
                }
                return null;
            };
            
            // Estrae entrambi i campi
            const enteProponente = getSafe(['afs:EnteProponente', 'ente', 'amministrazione']);
            const enteAppaltante = getSafe(['afs:DenominazioneEnte', 'denominazioneente']);

            return {
                esito: getSafe(['esito', 'stato']),
                cig: getSafe(['afs:CIG', 'CIG', 'cig']),
                enteProponente: enteProponente || 'N/D',
                enteAppaltante: enteAppaltante || 'N/D', 
                ente_raw: enteProponente, // Per la logica della mappa
                oggetto: getSafe(['afs:Oggetto', 'description', 'oggetto', 'titolo']),
                baseAsta: getSafe(['afs:a_base_asta', 'importo', 'basedasta']) || 'N/D',
                contratto: getSafe(['afs:Contratto', 'tipologia', 'contratto']) || 'N/D',
                scadenza: getSafe(['afs:DtScadenzaBandoTecnical', 'afs:dtscadenza', 'dtscadenza', 'scadenza']) || 'N/D'
            };
        }

        // --- FUNZIONE DI FETCH GENERICA (riutilizzata da entrambi) ---
        async function fetchProxy(url) {
            const ts = Date.now();
            const TIMEOUT_MS = 30000; 
            const proxies = [
                { url: `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&_t=${ts}`, type: 'json' },
                { url: `https://corsproxy.io/?${encodeURIComponent(url)}`, type: 'text' },
                { url: `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`, type: 'text'},
                { url: `https://thingproxy.freeboard.io/fetch/${url}`, type: 'text' },
                { url: `https://cors.eu.org/${url}`, type: 'text' }
            ];

            for (const proxy of proxies) {
                try {
                    const controller = new AbortController();
                    const id = setTimeout(() => controller.abort(), TIMEOUT_MS);
                    const res = await fetch(proxy.url, { signal: controller.signal, cache: 'no-store' });
                    clearTimeout(id);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    
                    const xmlStr = proxy.type === 'json' ? (await res.json()).contents : await res.text();
                    if (!xmlStr || xmlStr.trim().length < 50 || (!xmlStr.includes('<rss') && !xmlStr.includes('<feed') && !xmlStr.startsWith('<?xml'))) {
                         throw new Error("Risposta invalida o non XML");
                    }
                    const xmlDoc = new DOMParser().parseFromString(xmlStr, "application/xml");
                    if (xmlDoc.querySelector("parsererror")) throw new Error("XML non valido");
                    return xmlDoc; // Successo! Restituisce il documento XML
                } catch (e) { console.warn(`Proxy fallito: ${proxy.url}`, e); }
            }
            throw new Error("Tutti i proxy falliti");
        }

        // --- FUNZIONE CARICAMENTO BANDI (per tab 1, 2, 3) ---
        async function fetchFeed() {
            // Mostra indicatore di caricamento appropriato
            if (currentView === 'mappa') {
                mapLoadingOverlay.classList.add('active');
            } else {
                 feedContainer.innerHTML = `<div class="loading-container"><div class="loading-spinner"></div><div class="loading-text">Caricamento gare...</div></div>`;
            }
            resultsStatusContainer.innerHTML = '';
            paginationControls.style.display = 'none';
            
            const feedUrl = buildUrl();
            try {
                const xmlDoc = await fetchProxy(feedUrl);
                fetchedItems = Array.from(xmlDoc.querySelectorAll("item"));
                
                displayItems();
                updateMap(); // Aggiorna i dati della mappa
                
                mapLoadingOverlay.classList.remove('active');
                nextPageBtn.disabled = fetchedItems.length < numResultsInput.value;
                currentPageSpan.textContent = `Pagina ${currentPage}`;
                paginationControls.style.display = 'flex';
            } catch (error) {
                handleError(error);
            }
        }
        
        // --- FUNZIONE CARICAMENTO ESITI (per tab 4) ---
        async function fetchEsitoByCig() {
            const cig = document.getElementById('cig-input').value.trim();
            if (!cig) {
                esitoContainer.innerHTML = '<p class="error-message">Devi inserire un CIG per la ricerca.</p>';
                return;
            }
            
            esitoContainer.innerHTML = `<div class="loading-container"><div class="loading-spinner"></div><div class="loading-text">Ricerca esito per CIG: ${cig}...</div></div>`;
            resultsStatusContainer.innerHTML = '';
            paginationControls.style.display = 'none';
            
            const feedUrl = buildEsitoUrl(cig);
            try {
                const xmlDoc = await fetchProxy(feedUrl);
                const esitiItems = Array.from(xmlDoc.querySelectorAll("item"));
                
                if (esitiItems.length === 0) {
                    esitoContainer.innerHTML = `<p style="text-align:center; padding: 20px;">Nessun esito trovato per il CIG: ${cig}</p>`;
                    return;
                }
                
                let html = '<ul>';
                esitiItems.forEach(item => {
                    const title = item.querySelector("title")?.textContent || 'Esito';
                    const description = item.querySelector("description")?.textContent || 'Dettagli non disponibili';
                    let linkRaw = item.querySelector("link")?.textContent?.trim() || '#';
                    linkRaw = linkRaw.replace(/\/\/*portale\//g, '/portalegare/');
                    const txt = document.createElement("textarea");
                    txt.innerHTML = linkRaw;
                    linkRaw = txt.value;
                    
                    html += `
                        <li>
                            <div class="esito-info">
                                <strong>${title}</strong>
                                <p>${description}</p>
                            </div>
                            <div class="esito-link">
                                <a href="${linkRaw}" target="_blank" rel="noopener noreferrer" class="btn-details">Dettaglio</a>
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';
                esitoContainer.innerHTML = html;

            } catch (error) {
                esitoContainer.innerHTML = `<div class="error-message">Impossibile caricare il feed. I servizi esterni non rispondono.<br><button id="retry-btn-esito">Riprova</button></div>`;
                document.getElementById('retry-btn-esito').addEventListener('click', fetchEsitoByCig);
            }
        }

        function handleError(lastError) {
            console.error("Errore caricamento:", lastError);
            let msg = "Impossibile caricare il feed. I servizi esterni non rispondono.";
            feedContainer.innerHTML = `<div class="error-message">${msg}<br><button id="retry-btn">Riprova</button></div>`;
            mapLoadingOverlay.classList.remove('active');
            document.getElementById('retry-btn').addEventListener('click', fetchFeed);
        }

        // --- EVENT LISTENERS ---
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (currentView === 'cerca-esito') {
                fetchEsitoByCig();
            } else {
                currentPage = 1;
                fetchFeed();
            }
        });

        prevPageBtn.addEventListener('click', () => { if (currentPage > 1) { currentPage--; fetchFeed(); } });
        nextPageBtn.addEventListener('click', () => { currentPage++; fetchFeed(); });
        
        tabButtons.forEach(btn => btn.addEventListener('click', () => {
            tabButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentView = btn.dataset.view;

            // Logica per mostrare/nascondere elementi
            if (currentView === 'cerca-esito') {
                searchForm.classList.add('esito-mode');
                paginationControls.style.display = 'none';
                resultsStatusContainer.innerHTML = '';
            } else {
                searchForm.classList.remove('esito-mode');
                // La paginazione verrà mostrata da fetchFeed se ci sono risultati
            }
            
            // Se passo alla vista mappa, assicuriamoci che sia aggiornata e visibile
            if (currentView === 'mappa') {
                updateMap();
            }
            displayItems(); // Ridisegna l'interfaccia 
        }));

        // --- MODIFICA: Due listener separati per i gruppi di pillole ---
        contractPills.forEach(pill => pill.addEventListener('click', () => {
            if (pill.classList.contains('active')) {
                pill.classList.remove('active');
                selectedContractType = '';
            } else {
                contractPills.forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                selectedContractType = pill.dataset.cat;
            }
            currentPage = 1;
            fetchFeed();
        }));

        merceologicaPills.forEach(pill => pill.addEventListener('click', () => {
            if (pill.classList.contains('active')) {
                pill.classList.remove('active');
                selectedMerceologica = '';
            } else {
                merceologicaPills.forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                selectedMerceologica = pill.dataset.cat;
            }
            currentPage = 1;
            fetchFeed();
        }));
        // --- FINE MODIFICA ---

        document.addEventListener("DOMContentLoaded", () => {
             populateEnteSelects(); // Chiamata alla nuova funzione
             fetchFeed();
        });
    </script>
</body>
</html>